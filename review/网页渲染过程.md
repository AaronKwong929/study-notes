# 网页渲染过程

## 完整流程

- 构建 dom 树

  - 输入 html 文本，html 解析器解析，输出 dom 树

- 样式计算

  获取 link 标签引用的 css，style 标签的 css，行内 css

  1. 渲染引擎接收 css 文本 - 将 css 文本转换为 **styleSheets**

  2. 属性值标准化 2em => 32px / red => rgb(255,0,0) / font-weight: bold => font-weight: 700

  3. 计算每个节点具体样式：每个节点都会包含父节点的样式（层叠 / 继承）

- 布局阶段

  - 根据 dom 树和 css 树创建布局树（只包含可见元素）

- 分层

  - 没有单独图层的元素从属于父级图层

  - 拥有 BFC 的元素会单独提升成一层

  - 需要裁剪的地方会创建图层

    - 例如：文字显示超过了限定区域

  - 滚动条会被创建单独的图层

- 绘制

  - `绘制线程`将图层拆分成很多简单绘制指令

  - 不参与绘制，仅输出 **绘制指令列表**

- 栅格化

  - `渲染主进程`把绘制列表交给`合成线程`

  - 合成线程把图层分成图块

  - 合成线程根据`用户视口`附近图块优先生成位图

  - 栅格化即把图块生成位图

    - 图块是栅格化最小执行单位

    - 栅格化会使用 GPU 加速，生成结果会保存在 GPU 中 （涉及 IPC）

- 合成

  - 所有位图生成完后，渲染进程的合成线程向浏览器主进程发出`DrawQuad`命令

  - 主进程接收到后生成页面并显示，结束渲染

## 一图总结

![](https://cdn.jsdelivr.net/gh/aaronkwong929/pictures/20210804210434.png)
