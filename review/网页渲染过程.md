# 网页渲染过程

- 按渲染时间顺序 分下列阶段

  - 构建 dom 树

    1. 输入 html

    2. html 解析器解析

    3. 输出 dom 树

  - 样式计算

    link 引用 css， style 标签 css， 行内 css

    - 渲染引擎接收 css 文本 - 将 css 文本转换为 **styleSheets**

    - 属性值标准化

      - 2em => 32px

      - red => rgb(255,0,0)

      - font-weight: bold => font-weight: 700

    - 计算每个节点具体样式

      - css 继承/层叠：每个节点都会包含父节点的样式

  - 布局阶段

    - 创建布局树（只包含可见元素

  - 分层

    - 为特定图层生成分层树

      - 没有单独图层的元素从属于父级图层

      - 拥有 BFC 的元素会单独提升成一层

      - 需要裁剪的地方会创建图层

        - 文字显示超过了限定区域

        - 滚动条会被创建单独的图层

  - 绘制

    - 将图层绘制拆分成很多简单指令

    - 输出的内容是 **绘制指令列表** 不参与绘制

  - 栅格化

    - `渲染主进程`把绘制列表交给`合成线程`

    - 合成线程把图层分成图块

      - 用户能看到的视口（view port）大小有限，全部合成开销较大

    - 合成线程根据视口附近图块优先生成位图

    - 生成位图的操作由栅格化执行，栅格化即把图块生成位图

      - 图块是栅格化最小执行单位

    - 栅格化会使用 GPU 加速，生成结果会保存在 GPU 中 _IPC_

  - 合成

    - 所有位图生成完后，渲染进程的合成线程向浏览器主进程发出`DrawQuad`命令

    - 主进程接收到后将位图放入内存中

    - 主进程将内存的位图显示在屏幕上

![](https://cdn.jsdelivr.net/gh/aaronkwong929/pictures/20210804210434.png)
