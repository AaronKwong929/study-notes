# 从 url 到网页渲染的导航流程

## 前置知识

浏览器进程最少四个：主进程，网络进程，渲染进程，GPU 进程，插件进程

浏览器主进程：页面交互，子进程管理，文件存储

网络进程是面向渲染进程和浏览器进程等提供网络下载功能。

渲染进程的主要职责是把从网络下载的 HTML、JavaScript、CSS、图片等资源解析为可以显示和交互的页面。
因为渲染进程所有的内容都是通过网络获取的，会存在一些恶意代码利用浏览器漏洞对系统进行攻击，所以运行在渲染进程里面的代码是不被信任的。

## 具体流程

- 用户输入 URL

- 处理输入信息

  - 判断输入关键字还是网址

    - 关键字：使用默认搜索引擎，将关键字拼凑成 URL

    - 符合 URL 规则：拼接协议合成完整 URL

  - 用户回车后页面 favicon 变成旋转图标（提交文档阶段才会替换成新的）

- 发起 URL 请求

  - 浏览器主进程通过进程通信（IPC）把 URL 发送到网络进程

  - 网络进程检查是否有[缓存](/review/网页缓存.md)

    - 有缓存则直接返回资源给主进程

    - 没有资源则进入网络请求流程

      - [DNS 解析](/review/dns解析.md) -> 获得服务器 IP 地址

      - 若是 HTTPS 请求，要建立 TLS 连接

      - 利用 IP 地址和服务器建立 [TCP 连接](/review/tcp连接.md)

      - 建立 TCP 连接之后，浏览器构建请求头，请求行，并把与该域名相关的 cookie 等数据加入到请求头，然后向服务器发送请求信息

      - 服务器接收到请求后，根据请求信息构造响应数据：响应行、响应头、响应体等，发送给网络进程

      - 网络进程接收到之后，开始解析响应头

- 读取响应头信息

  - 读取[状态码](/review/http状态码.md)，若 code = 301/302，需要重定向，从响应头 Location 字段获得重定向地址后，重新走上面的流程

  - code = 200，解析响应数据类型（读 Content-Type）

    - text/html **准备渲染进程**

    - application/octet-stream 字节流类型，提交给下载管理器，**结束导航流程**

- 准备渲染进程

  - Chrome 通常为每个页面分配一个渲染进程。若打开多个同一站点标签页（same-site，**同根域名**，**同协议**，包含所有子域名和端口）则共用一个渲染进程

  - 从一个页面打开另一个新页面，如果新页面也是 same-site，复用父页面的渲染进程，否则单独开一个渲染进程

- 提交文档（文档指响应体数据）

  - `提交文档`消息由 `浏览器主进程` 发出，`渲染进程` 接收后，与网络进程建立传输管道

  - 文档数据传输完成后，`渲染进程`发送`确认提交`给`浏览器主进程`

- 确认文档提交

  - 浏览器接收到确认提交信息，更新浏览器界面状态

    - 安全状态（https 锁）

    - 地址栏 url

    - 前进后退的 history 状态

    - 更新页面（变白屏）

  **导航流程结束，进入渲染阶段**

- 页面解析/加载子资源

- 页面加载

- 完成

## 图片流程

![](https://cdn.jsdelivr.net/gh/aaronkwong929/pictures/20210803214115.png)
