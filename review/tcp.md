# TCP 连接的细节

TCP 工作在传输层，没有 IP（IP 在网络层）但有目标端口和源端口

## TCP 重传机制

- 超时重传

  - TCP 要求发送方每发送一个报文段就会起一个定时器等待确认信息，如果定时器超时还没接收到 ACK，则认为丢失/损坏 -- 重传（tcp 可靠性保证）

- 快速重传

  - 例如发送 12345，缺了 2，345 已收到

  - 如果包没送达就一直 ACK 可能丢失的包，发送方重复接收到同一个 ACK 就重传，在这里是接收方连续 ack 了 3 个 3

  - 发送方接收到 3 个 3，重传，接收方收到 2，因为此时 345 已收到，返回 ack=6 --解决超时重传要`死等timeout`的问题

- SACK

- D-SACK(duplicate-sack)

## TCP 滑动窗口（流量控制）

接收端告诉发送端自己有多少缓冲区可以接收数据，发送端根据这个缓冲区确定滑动窗口

滑动窗口分为四个部分

1. 已经收到 ACK 的数据

2. 已发出但还没被 ACK 的数据

3. 未发出，但是接收方有空余位置可以接收的数据

4. 未发出，接收方没空余位置接收的数据

## TCP 拥塞控制

- 慢启动

  - 初始化为 `cwnd = 1`(Congestion Window)

  - 每接收到一个 ack，`cwnd++`

  - 每经过一个 rtt `cwnd = cwnd^2`

  - ssthresh（slow start threshold），是一个上限，当 cwnd >= ssthresh 时，就会进入`拥塞避免算法`

- 拥塞避免

  - 收到一个 ACK 时，cwnd = cwnd + 1/cwnd

  - 当每过一个 RTT 时，cwnd = cwnd + 1

- 拥塞状态算法

- 快速恢复算法

## 一些问题

### tcp 和 udp 区别

|              |              UDP               |        TCP         |
| :----------: | :----------------------------: | :----------------: |
|   是否连接   |             无连接             |      面向连接      |
|   是否可靠   |      不可靠，无流控和拥控      | 可靠，使用流控拥控 |
|   传输方式   |            面向报文            |     面向字节流     |
| 对象连接个数 | 一对一，一对多，多对一，多对多 |       一对一       |
| 报文首部开销 |             8 字节             | 20 字节 - 60 字节  |
|     场景     |         视频通话、直播         |     文件传输等     |

### tcp 如何实现可靠性

拥塞控制，流量控制，超时重传，确认应答，序列号等

### tcp 如何提高传输效率

滑动窗口，快速重传

### 三次握手

![](https://raw.githubusercontent.com/AaronKwong929/pictures/master/20210815110553.png)

三次握手，主要是要初始化 Sequence Number 的初始值。通信的双方要互相通知对方自己的初始化的 Sequence Number SYN，全称 Synchronize Sequence Numbers。也就上图中的 x 和 y。这个号要作为以后的数据通信的序号，以保证应用层接收到的数据不会因为网络上的传输的问题而乱序（TCP 会用这个序号来拼接数据）。

#### 两次握手只能保证单向连接是畅通的

第一步，客户端给服务端发送一条消息：你好，服务端。第二步，服务端收到消息，同时给客户端回复一条消息：收到！你好客户端。

这样的两次握手过程， 客户端给服务端打招呼，服务端收到了，说明客户端可以正常给服务端发送数据。但是服务端给客户端打招呼，服务端没有收到反馈，也就不能确保服务端是否能正常给客户端发送消息。

只有经过第三次握手，才能确保双向都可以接收到对方的发送的数据 第三步，客户端收到服务端发送的消息，回复：收到！这样就证明了客户端能正常收到服务端的消息。

### 四次挥手

![](https://raw.githubusercontent.com/AaronKwong929/pictures/master/20210815110621.png)

对于 4 次挥手，其实`仔细看是 2 次`，因为 TCP 是`全双工`的，所以，发送方和接收方都需要 Fin 和 Ack。只不过，有一方是被动的，所以看上去就成了所谓的 4 次挥手。如果两边同时断连接，那就会就进入到 CLOSING 状态，然后到达 TIME_WAIT 状态。

[一些面试题](https://mp.weixin.qq.com/s/3FTuMZaUrT9Vw-ZScJkQbg)

![pic](https://raw.githubusercontent.com/AaronKwong929/pictures/master/20210815105853.png)
